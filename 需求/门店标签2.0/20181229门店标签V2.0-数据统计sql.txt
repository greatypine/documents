--TOP1-3
select * from (select b.*,row_number() over(partition by b.store_name order by tot desc) rn from (select toi.store_city_code,toi.store_name,p.type1,sum(toi.quantity) tot
from t_v_real_order_item toi
left join (select id,content_name,manager_category_names,split_part(manager_category_names,',',1) type1   from t_product 
where manager_category_names !='NULL' and manager_category_names is not null 
and length(manager_category_names)>1 and manager_category_names !='其它' and manager_category_names not like '%周边美食%'
and manager_category_names not like '%请选择%') p on p.id=toi.eshop_pro_id
where toi.store_city_code in('110100000000','120100000000','310100000000')
--and toi.order_group_id not in (select distinct order_group_id from t_v_real_order where payable_price>10000 or total_quantity>50)
and toi.store_name NOT LIKE '%测试%'
AND toi.store_name NOT LIKE '%企业购%' 
AND toi.store_name NOT LIKE '%内购%' 
AND toi.store_name NOT LIKE '%校园%' 
and toi.store_name NOT LIKE '%停用%' 
and toi.store_name NOT LIKE '%仓储%'
AND toi.store_name NOT LIKE '%云门店%' 
AND toi.store_name NOT LIKE '%前置仓%'
AND toi.store_name NOT LIKE '%爱科%'
AND toi.store_name NOT LIKE '%大学%'
AND toi.store_name NOT LIKE '%仓店%'
AND toi.store_name NOT LIKE '%电视端%'
and toi.order_create_time<now()
and toi.order_create_time>=date_sub(now(),180)
and p.type1 is not null
group by toi.store_city_code,toi.store_name,p.type1) b )c
where c.rn<=3;

--商业成熟度
SELECT t.towncode,count(distinct t.second_class),count(1) FROM `t_dazhongdp` t
where t.towncode in 
#门店运行街道
('110102016000','110102011000','110105005000','110105024000','110105021000','110105016000','110105003000','110102015000','110101012000','110105030000','110102010000','110102014000','110105031000','110101006000','110106010000','110106004000','110105002000','110105029000','110105035000','110106013000','110102001000','110102007000','110106002000','110106007000','110114011000','110105043000','110108011000','110108008000','110105014000','110108025000','110107001000','110106015000','110105028000','110115003000','110106003000','110105025000','110105018000','110101016000','110108002000','110105015000','110105023000','110101010000','110108017000','110115004000','110108024000','110108012000','110105004000','110101005000','110102017000','110106008000','110102020000','310104015000','110114009000','110114008000','110115011000','110115009000','110105033000','110112004000','120112103000','110112114000','120111001000','110105037000','120116007000','110108028000','120112100000','110105013000','120116001000','120106010000','120102002000','310110019000','120101004000','120101001000','310107016000','120110003000','310112107000','310106006000','120105001000','120111002000','120104008000','310115016000','310110013000','120103010000','120104006000','120103007000','120102009000','120103012000','110108027000','310113111000','310113113000','120104011000','120106004000','120105009000','120102010000','120102005000','110112003000','110107004000','110107003000','120113102000','110105011000','110105026000','110105012000','110101017000','110105001000','120103009000','310104014000','310104007000','120105008000','120106003000','120103004000','120102004000','120105003000','110105032000','110115006000','110112006000','120105005000','110101009000','310113003000','110107005000','110108018000','110105017000','120104005000','310106022000','310101015000','310109011000','310110101000','120104010000','310101013000','310107015000','310115130000','110108006000','110102003000','110101013000','110107011000','120104003000','120104004000','120103006000','120106001000','120101005000','110105006000','110102009000','110108005000','120102006000','110108003000','310101002000','110108019000','110107006000','310112006000','310106014000','310112108000','310115015000','120116005000','310115014000','110112005000','120102001000','310109009000','110105007000','310110008000','310115013000','310115007000','120104002000','310105002000','110105022000','310110020000','120105004000','120105002000','120105007000','110102012000','110108001000','120106006000','110108021000','310115012000','110108022000','110101003000','110114001000','120101003000','120104007000','120106009000','120111100000','120105010000','120112101000','310112101000','110114010000'
)
group by t.towncode ;

--老年服务

SELECT t.towncode,count(distinct t.second_class),count(1) FROM `t_dazhongdp` t
where t.towncode in 
#门店运行街道
('110102016000','110102011000','110105005000','110105024000','110105021000','110105016000','110105003000','110102015000','110101012000','110105030000','110102010000','110102014000','110105031000','110101006000','110106010000','110106004000','110105002000','110105029000','110105035000','110106013000','110102001000','110102007000','110106002000','110106007000','110114011000','110105043000','110108011000','110108008000','110105014000','110108025000','110107001000','110106015000','110105028000','110115003000','110106003000','110105025000','110105018000','110101016000','110108002000','110105015000','110105023000','110101010000','110108017000','110115004000','110108024000','110108012000','110105004000','110101005000','110102017000','110106008000','110102020000','310104015000','110114009000','110114008000','110115011000','110115009000','110105033000','110112004000','120112103000','110112114000','120111001000','110105037000','120116007000','110108028000','120112100000','110105013000','120116001000','120106010000','120102002000','310110019000','120101004000','120101001000','310107016000','120110003000','310112107000','310106006000','120105001000','120111002000','120104008000','310115016000','310110013000','120103010000','120104006000','120103007000','120102009000','120103012000','110108027000','310113111000','310113113000','120104011000','120106004000','120105009000','120102010000','120102005000','110112003000','110107004000','110107003000','120113102000','110105011000','110105026000','110105012000','110101017000','110105001000','120103009000','310104014000','310104007000','120105008000','120106003000','120103004000','120102004000','120105003000','110105032000','110115006000','110112006000','120105005000','110101009000','310113003000','110107005000','110108018000','110105017000','120104005000','310106022000','310101015000','310109011000','310110101000','120104010000','310101013000','310107015000','310115130000','110108006000','110102003000','110101013000','110107011000','120104003000','120104004000','120103006000','120106001000','120101005000','110105006000','110102009000','110108005000','120102006000','110108003000','310101002000','110108019000','110107006000','310112006000','310106014000','310112108000','310115015000','120116005000','310115014000','110112005000','120102001000','310109009000','110105007000','310110008000','310115013000','310115007000','120104002000','310105002000','110105022000','310110020000','120105004000','120105002000','120105007000','110102012000','110108001000','120106006000','110108021000','310115012000','110108022000','110101003000','110114001000','120101003000','120104007000','120106009000','120111100000','120105010000','120112101000','310112101000','110114010000'
)
and  t.second_class  in 
('按摩/足疗','棋牌室','足疗按摩','洗涤护理','温泉','更多生活服务','生活配送','老年生活')
group by t.towncode ;

--年龄结构
select  store_name,b.type,count(1) from 
(select store_name,idcard,birthday,years,
(case when years>='2000' then '少年'
when years<'2000'and years>='1978' then '青年'
when  years<'1978'and years>='1958' then '中年'
when years<'1958' then '老年'
else ''end) type
from (select a1.store_name,a.idcard,a.birthday,
(case when idcard is not null and a.idcard <>'' then substr(idcard,7,4)
else substr(a.birthday,1,4) end) years
from daily_customer_associator a
left join(select distinct a2.store_name,a2.customer_id from  t_v_full_order a2) a1 on a.customer_id=a1.customer_id)s) b
group by b.type,store_name




#高端/中低端小区
select a.city,a.town_gb_code,a.town_name,type,count(1) from 
(SELECT t.*,
(CASE 
when t.style='别墅' or( t.style='住宅'and cast(t.rongji as SIGNED)>=4 and t.complete>='2005-01-01'and t.green>='30%' ) then'高端' else '中低端' end )type

 FROM `tp_tinyvillage_info` t 
where 
t.town_gb_code in 
#门店运行街道
('110102016000','110102011000','110105005000','110105024000','110105021000','110105016000','110105003000','110102015000','110101012000','110105030000','110102010000','110102014000','110105031000','110101006000','110106010000','110106004000','110105002000','110105029000','110105035000','110106013000','110102001000','110102007000','110106002000','110106007000','110114011000','110105043000','110108011000','110108008000','110105014000','110108025000','110107001000','110106015000','110105028000','110115003000','110106003000','110105025000','110105018000','110101016000','110108002000','110105015000','110105023000','110101010000','110108017000','110115004000','110108024000','110108012000','110105004000','110101005000','110102017000','110106008000','110102020000','310104015000','110114009000','110114008000','110115011000','110115009000','110105033000','110112004000','120112103000','110112114000','120111001000','110105037000','120116007000','110108028000','120112100000','110105013000','120116001000','120106010000','120102002000','310110019000','120101004000','120101001000','310107016000','120110003000','310112107000','310106006000','120105001000','120111002000','120104008000','310115016000','310110013000','120103010000','120104006000','120103007000','120102009000','120103012000','110108027000','310113111000','310113113000','120104011000','120106004000','120105009000','120102010000','120102005000','110112003000','110107004000','110107003000','120113102000','110105011000','110105026000','110105012000','110101017000','110105001000','120103009000','310104014000','310104007000','120105008000','120106003000','120103004000','120102004000','120105003000','110105032000','110115006000','110112006000','120105005000','110101009000','310113003000','110107005000','110108018000','110105017000','120104005000','310106022000','310101015000','310109011000','310110101000','120104010000','310101013000','310107015000','310115130000','110108006000','110102003000','110101013000','110107011000','120104003000','120104004000','120103006000','120106001000','120101005000','110105006000','110102009000','110108005000','120102006000','110108003000','310101002000','110108019000','110107006000','310112006000','310106014000','310112108000','310115015000','120116005000','310115014000','110112005000','120102001000','310109009000','110105007000','310110008000','310115013000','310115007000','120104002000','310105002000','110105022000','310110020000','120105004000','120105002000','120105007000','110102012000','110108001000','120106006000','110108021000','310115012000','110108022000','110101003000','110114001000','120101003000','120104007000','120106009000','120111100000','120105010000','120112101000','310112101000','110114010000'
)
) a
group by a.city,a.town_gb_code,a.town_name,type;

#老旧小区
select a.city,a.town_name,type,count(1) from 
(SELECT t.*,
(CASE 
when  t.complete<='1999-01-01' then'老旧小区' else '' end )type
 FROM `tp_tinyvillage_info` t 
where 
t.town_gb_code in 
#门店运行街道
('110102016000','110102011000','110105005000','110105024000','110105021000','110105016000','110105003000','110102015000','110101012000','110105030000','110102010000','110102014000','110105031000','110101006000','110106010000','110106004000','110105002000','110105029000','110105035000','110106013000','110102001000','110102007000','110106002000','110106007000','110114011000','110105043000','110108011000','110108008000','110105014000','110108025000','110107001000','110106015000','110105028000','110115003000','110106003000','110105025000','110105018000','110101016000','110108002000','110105015000','110105023000','110101010000','110108017000','110115004000','110108024000','110108012000','110105004000','110101005000','110102017000','110106008000','110102020000','310104015000','110114009000','110114008000','110115011000','110115009000','110105033000','110112004000','120112103000','110112114000','120111001000','110105037000','120116007000','110108028000','120112100000','110105013000','120116001000','120106010000','120102002000','310110019000','120101004000','120101001000','310107016000','120110003000','310112107000','310106006000','120105001000','120111002000','120104008000','310115016000','310110013000','120103010000','120104006000','120103007000','120102009000','120103012000','110108027000','310113111000','310113113000','120104011000','120106004000','120105009000','120102010000','120102005000','110112003000','110107004000','110107003000','120113102000','110105011000','110105026000','110105012000','110101017000','110105001000','120103009000','310104014000','310104007000','120105008000','120106003000','120103004000','120102004000','120105003000','110105032000','110115006000','110112006000','120105005000','110101009000','310113003000','110107005000','110108018000','110105017000','120104005000','310106022000','310101015000','310109011000','310110101000','120104010000','310101013000','310107015000','310115130000','110108006000','110102003000','110101013000','110107011000','120104003000','120104004000','120103006000','120106001000','120101005000','110105006000','110102009000','110108005000','120102006000','110108003000','310101002000','110108019000','110107006000','310112006000','310106014000','310112108000','310115015000','120116005000','310115014000','110112005000','120102001000','310109009000','110105007000','310110008000','310115013000','310115007000','120104002000','310105002000','110105022000','310110020000','120105004000','120105002000','120105007000','110102012000','110108001000','120106006000','110108021000','310115012000','110108022000','110101003000','110114001000','120101003000','120104007000','120106009000','120111100000','120105010000','120112101000','310112101000','110114010000'
)) a
group by a.city,a.town_name,type;
#住宅小区
select t.city,t.town_gb_code,sum(cast(t.building_area as SIGNED)) from `tp_tinyvillage_info` t 
where t.town_gb_code in 
#门店运行街道
('110102016000','110102011000','110105005000','110105024000','110105021000','110105016000','110105003000','110102015000','110101012000','110105030000','110102010000','110102014000','110105031000','110101006000','110106010000','110106004000','110105002000','110105029000','110105035000','110106013000','110102001000','110102007000','110106002000','110106007000','110114011000','110105043000','110108011000','110108008000','110105014000','110108025000','110107001000','110106015000','110105028000','110115003000','110106003000','110105025000','110105018000','110101016000','110108002000','110105015000','110105023000','110101010000','110108017000','110115004000','110108024000','110108012000','110105004000','110101005000','110102017000','110106008000','110102020000','310104015000','110114009000','110114008000','110115011000','110115009000','110105033000','110112004000','120112103000','110112114000','120111001000','110105037000','120116007000','110108028000','120112100000','110105013000','120116001000','120106010000','120102002000','310110019000','120101004000','120101001000','310107016000','120110003000','310112107000','310106006000','120105001000','120111002000','120104008000','310115016000','310110013000','120103010000','120104006000','120103007000','120102009000','120103012000','110108027000','310113111000','310113113000','120104011000','120106004000','120105009000','120102010000','120102005000','110112003000','110107004000','110107003000','120113102000','110105011000','110105026000','110105012000','110101017000','110105001000','120103009000','310104014000','310104007000','120105008000','120106003000','120103004000','120102004000','120105003000','110105032000','110115006000','110112006000','120105005000','110101009000','310113003000','110107005000','110108018000','110105017000','120104005000','310106022000','310101015000','310109011000','310110101000','120104010000','310101013000','310107015000','310115130000','110108006000','110102003000','110101013000','110107011000','120104003000','120104004000','120103006000','120106001000','120101005000','110105006000','110102009000','110108005000','120102006000','110108003000','310101002000','110108019000','110107006000','310112006000','310106014000','310112108000','310115015000','120116005000','310115014000','110112005000','120102001000','310109009000','110105007000','310110008000','310115013000','310115007000','120104002000','310105002000','110105022000','310110020000','120105004000','120105002000','120105007000','110102012000','110108001000','120106006000','110108021000','310115012000','110108022000','110101003000','110114001000','120101003000','120104007000','120106009000','120111100000','120105010000','120112101000','310112101000','110114010000'
)
group by t.city,t.town_gb_code;
#写字楼面积
select  s.city,s.town_gb_code,sum(cast(s.building_area as SIGNED)) from tp_office_info s
where s.town_gb_code in 
#门店运行街道
('110102016000','110102011000','110105005000','110105024000','110105021000','110105016000','110105003000','110102015000','110101012000','110105030000','110102010000','110102014000','110105031000','110101006000','110106010000','110106004000','110105002000','110105029000','110105035000','110106013000','110102001000','110102007000','110106002000','110106007000','110114011000','110105043000','110108011000','110108008000','110105014000','110108025000','110107001000','110106015000','110105028000','110115003000','110106003000','110105025000','110105018000','110101016000','110108002000','110105015000','110105023000','110101010000','110108017000','110115004000','110108024000','110108012000','110105004000','110101005000','110102017000','110106008000','110102020000','310104015000','110114009000','110114008000','110115011000','110115009000','110105033000','110112004000','120112103000','110112114000','120111001000','110105037000','120116007000','110108028000','120112100000','110105013000','120116001000','120106010000','120102002000','310110019000','120101004000','120101001000','310107016000','120110003000','310112107000','310106006000','120105001000','120111002000','120104008000','310115016000','310110013000','120103010000','120104006000','120103007000','120102009000','120103012000','110108027000','310113111000','310113113000','120104011000','120106004000','120105009000','120102010000','120102005000','110112003000','110107004000','110107003000','120113102000','110105011000','110105026000','110105012000','110101017000','110105001000','120103009000','310104014000','310104007000','120105008000','120106003000','120103004000','120102004000','120105003000','110105032000','110115006000','110112006000','120105005000','110101009000','310113003000','110107005000','110108018000','110105017000','120104005000','310106022000','310101015000','310109011000','310110101000','120104010000','310101013000','310107015000','310115130000','110108006000','110102003000','110101013000','110107011000','120104003000','120104004000','120103006000','120106001000','120101005000','110105006000','110102009000','110108005000','120102006000','110108003000','310101002000','110108019000','110107006000','310112006000','310106014000','310112108000','310115015000','120116005000','310115014000','110112005000','120102001000','310109009000','110105007000','310110008000','310115013000','310115007000','120104002000','310105002000','110105022000','310110020000','120105004000','120105002000','120105007000','110102012000','110108001000','120106006000','110108021000','310115012000','110108022000','110101003000','110114001000','120101003000','120104007000','120106009000','120111100000','120105010000','120112101000','310112101000','110114010000'
)
group by  s.city,s.town_gb_code;
